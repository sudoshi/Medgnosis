name: Deploy to Production

on:
  push:
    branches:
      - main

jobs:
  deploy:
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v3

      # Frontend build
      - name: Set up Node.js
        uses: actions/setup-node@v3
        with:
          node-version: '18.17.0'
          cache: 'npm'
          cache-dependency-path: frontend/package-lock.json

      - name: Install and build frontend
        working-directory: ./frontend
        env:
          NEXT_TELEMETRY_DISABLED: 1
          NODE_ENV: production
          NEXT_PUBLIC_SKIP_PREFLIGHT_CHECK: true
          NEXT_IGNORE_ESLINT_DURING_BUILDS: true
          SKIP_TYPESCRIPT_CHECK: true
        run: |
          npm ci
          npm list autoprefixer postcss tailwindcss typescript @types/node
          npm run build
          cp server.js .next/standalone/

      # Backend setup
      - name: Set up PHP
        uses: shivammathur/setup-php@v2
        with:
          php-version: '8.2'
          extensions: mbstring, xml, ctype, iconv, intl, pdo_mysql, dom, filter, gd, json, libxml, mbstring, pdo
          coverage: none

      - name: Get composer cache directory
        id: composer-cache
        working-directory: ./backend
        run: echo "dir=$(composer config cache-files-dir)" >> $GITHUB_OUTPUT

      - name: Cache composer dependencies
        uses: actions/cache@v3
        with:
          path: ${{ steps.composer-cache.outputs.dir }}
          key: ${{ runner.os }}-composer-${{ hashFiles('**/composer.lock') }}
          restore-keys: ${{ runner.os }}-composer-

      - name: Install backend dependencies
        working-directory: ./backend
        run: composer install --prefer-dist --no-progress --no-interaction --optimize-autoloader

      - name: Configure backend
        working-directory: ./backend
        env:
          DB_PASSWORD: ${{ secrets.DB_PASSWORD || 'acumenus' }}
        run: |
          # Create .env file from template
          cat > .env << EOF
          APP_NAME=Medgnosis
          APP_ENV=production
          APP_KEY=
          APP_DEBUG=false
          APP_URL=https://demo.medgnosis.app

          LOG_CHANNEL=stack
          LOG_DEPRECATIONS_CHANNEL=null
          LOG_LEVEL=warning

          DB_CONNECTION=pgsql
          DB_HOST=localhost
          DB_PORT=5432
          DB_DATABASE=PHM
          DB_USERNAME=postgres
          DB_PASSWORD=${DB_PASSWORD}
          DB_SCHEMA=prod

          BROADCAST_DRIVER=log
          CACHE_DRIVER=file
          FILESYSTEM_DISK=local
          QUEUE_CONNECTION=sync
          SESSION_DRIVER=file
          SESSION_LIFETIME=120

          SANCTUM_STATEFUL_DOMAINS=demo.medgnosis.app
          SESSION_DOMAIN=.medgnosis.app
          FRONTEND_URL=https://demo.medgnosis.app

          CORS_ALLOWED_ORIGINS=https://demo.medgnosis.app
          EOF

          php artisan key:generate
          php artisan config:cache
          php artisan route:cache
          php artisan view:cache

      # Deploy to server
      - name: Verify build artifacts
        run: |
          echo "Verifying frontend build artifacts..."
          if [ -d "frontend/.next/standalone" ]; then
            echo "✅ Frontend build artifacts exist"
            ls -la frontend/.next/standalone
          else
            echo "❌ Frontend build artifacts missing"
            exit 1
          fi
          
          echo "Verifying backend files..."
          if [ -d "backend" ]; then
            echo "✅ Backend files exist"
            ls -la backend
          else
            echo "❌ Backend files missing"
            exit 1
          fi
      
      # Test SSH connection before deployment
      - name: Test SSH connection
        uses: appleboy/ssh-action@master
        with:
          host: ${{ secrets.SSH_HOST }}
          username: ${{ secrets.SSH_USER }}
          key: ${{ secrets.SSH_PRIVATE_KEY }}
          script: echo "SSH connection successful"
          
      # Backup .env file if it exists
      - name: Backup .env file
        uses: appleboy/ssh-action@master
        with:
          host: ${{ secrets.SSH_HOST }}
          username: ${{ secrets.SSH_USER }}
          key: ${{ secrets.SSH_PRIVATE_KEY }}
          script: |
            # Create backup directory in user's home
            mkdir -p ~/medgnosis-backup
            
            # Backup .env file if it exists (without sudo)
            if [ -f "/var/www/Medgnosis/backend/.env" ] && [ -r "/var/www/Medgnosis/backend/.env" ]; then
              cp /var/www/Medgnosis/backend/.env ~/medgnosis-backup/.env
              echo ".env file backed up successfully"
            else
              echo "No readable .env file found or no read permission"
            fi

      # Deploy backend directly
      # Note: If deployment fails with "Could not resolve hostname", 
      # update SSH_HOST secret to use an IP address instead of a hostname
      - name: Deploy backend
        uses: burnett01/rsync-deployments@5.2.1
        with:
          switches: -avzr --delete --exclude=".env" --verbose
          path: backend/
          remote_path: /var/www/Medgnosis/backend
          remote_host: ${{ secrets.SSH_HOST }}
          remote_user: ${{ secrets.SSH_USER }}
          remote_key: ${{ secrets.SSH_PRIVATE_KEY }}

      # Deploy frontend directly
      - name: Deploy frontend
        uses: burnett01/rsync-deployments@5.2.1
        with:
          switches: -avzr --delete --verbose
          path: frontend/.next/standalone/
          remote_path: /var/www/Medgnosis/frontend
          remote_host: ${{ secrets.SSH_HOST }}
          remote_user: ${{ secrets.SSH_USER }}
          remote_key: ${{ secrets.SSH_PRIVATE_KEY }}

      # Restore .env file if it was backed up
      - name: Restore .env file
        uses: appleboy/ssh-action@master
        with:
          host: ${{ secrets.SSH_HOST }}
          username: ${{ secrets.SSH_USER }}
          key: ${{ secrets.SSH_PRIVATE_KEY }}
          script: |
            # Restore .env if it was backed up
            if [ -f ~/medgnosis-backup/.env ]; then
              echo "Restoring .env file..."
              cp ~/medgnosis-backup/.env /var/www/Medgnosis/backend/.env
              echo ".env file restored successfully"
            fi
            
            # Clean up backup
            rm -rf ~/medgnosis-backup

      # Copy server.js to frontend directory if needed
      - name: Copy server.js
        uses: appleboy/ssh-action@master
        with:
          host: ${{ secrets.SSH_HOST }}
          username: ${{ secrets.SSH_USER }}
          key: ${{ secrets.SSH_PRIVATE_KEY }}
          script: |
            # Copy server.js to frontend directory if needed
            if [ ! -f "/var/www/Medgnosis/frontend/server.js" ]; then
              echo "Copying server.js to frontend directory..."
              cp frontend/.next/standalone/server.js /var/www/Medgnosis/frontend/ 2>/dev/null || echo "Could not copy server.js"
            fi

      # Notify completion
      - name: Notify completion
        uses: appleboy/ssh-action@master
        with:
          host: ${{ secrets.SSH_HOST }}
          username: ${{ secrets.SSH_USER }}
          key: ${{ secrets.SSH_PRIVATE_KEY }}
          script: |
            echo "Deployment completed successfully on $(date)" > ~/deploy-log.txt
            echo "Note: Service restart may need to be done manually by an administrator"
            
            # Verify deployment
            curl -s -o /dev/null -w "HTTP Status: %{http_code}" https://demo.medgnosis.app || echo "Could not verify deployment"
