<IfModule mod_ssl.c>
<VirtualHost *:443>
    ServerName medgnosis.acumenus.net

    # --- SSL ---
    SSLEngine on
    SSLCertificateFile /etc/letsencrypt/live/medgnosis.acumenus.net/fullchain.pem
    SSLCertificateKeyFile /etc/letsencrypt/live/medgnosis.acumenus.net/privkey.pem
    Include /etc/letsencrypt/options-ssl-apache.conf

    # --- Static web dashboard (Vite production build) ---
    DocumentRoot /home/smudoshi/Github/Medgnosis/apps/web/dist

    <Directory /home/smudoshi/Github/Medgnosis/apps/web/dist>
        Options -Indexes +FollowSymLinks
        AllowOverride None
        Require all granted

        # SPA fallback: serve index.html for all non-file routes
        FallbackResource /index.html
    </Directory>

    # --- Reverse proxy: WebSocket (must come before /api) ---
    ProxyPreserveHost On

    RewriteEngine On
    RewriteCond %{HTTP:Upgrade} websocket [NC]
    RewriteCond %{HTTP:Connection} upgrade [NC]
    RewriteRule ^/api/v1/ws$ ws://127.0.0.1:3081/api/v1/ws [P,L]

    # --- Reverse proxy: API ---
    ProxyPass /api/ http://127.0.0.1:3081/api/
    ProxyPassReverse /api/ http://127.0.0.1:3081/api/

    ProxyPass /health http://127.0.0.1:3081/health
    ProxyPassReverse /health http://127.0.0.1:3081/health

    # --- Security headers ---
    Header always set X-Content-Type-Options "nosniff"
    Header always set X-Frame-Options "DENY"
    Header always set Referrer-Policy "strict-origin-when-cross-origin"
    Header always set Permissions-Policy "camera=(), microphone=(), geolocation=()"

    # --- Logging ---
    ErrorLog ${APACHE_LOG_DIR}/medgnosis-error.log
    CustomLog ${APACHE_LOG_DIR}/medgnosis-access.log combined
</VirtualHost>
</IfModule>
